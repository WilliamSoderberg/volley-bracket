<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>VolleyManager</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.svg') }}">
    <!-- Link to the compiled CSS file we are about to generate -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dist/output.css') }}">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        // Check local storage or system preference on load
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            padding-top: env(safe-area-inset-top);
        }

        /* Prevent elastic scroll on body, allow internal scroll */
        .scroll-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>

<body
    class="bg-zinc-100 dark:bg-zinc-900 text-zinc-800 dark:text-zinc-100 h-[100dvh] flex flex-col overflow-hidden transition-colors duration-200">

    <!-- Scrollable Main Container -->
    <div class="scroll-container w-full">
        <div class="container mx-auto p-3 max-w-4xl">
            <!-- Header: Row layout for all screens -->
            <header class="flex flex-row justify-between mb-8 gap-4">
                <div class="flex items-center gap-3">
                    <i class="ph ph-volleyball text-3xl md:text-4xl text-orange-500"></i>
                    <div>
                        <h1 class="text-xl md:text-3xl font-bold text-zinc-900 dark:text-white leading-tight">
                            VolleyManager</h1>
                        <p class="text-xs md:text-base text-zinc-500 dark:text-zinc-400 hidden md:block">Tournament
                            Organizer</p>
                    </div>
                </div>
                <div id="authControls"></div>
            </header>

            <!-- Main Actions Row -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-zinc-700 dark:text-zinc-300">Tournaments</h2>
                <div id="createBtnContainer"></div>
            </div>

            <!-- TOURNAMENT SECTIONS -->
            <div class="space-y-8 pb-20">
                {% if live %}
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <h3 class="text-sm font-bold text-zinc-500 uppercase tracking-wider">Live Today</h3>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">{% for id, t in live.items() %}{% include
                        'partials/tournament_card.html' %}{% endfor %}</div>
                </div>
                {% endif %}
                {% if future %}
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <i class="ph ph-calendar-blank text-zinc-500"></i>
                        <h3 class="text-sm font-bold text-zinc-500 uppercase tracking-wider">Upcoming</h3>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        {% for id, t in future.items() %}
                        <div class="{% if loop.index > 4 %}hidden upcoming-extra{% endif %}">
                            {% include 'partials/tournament_card.html' %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if future|length > 4 %}
                    <div class="mt-4 text-center">
                        <button id="showMoreUpcomingBtn" data-count="{{ future|length }}" onclick="toggleUpcoming()"
                            class="text-sm text-zinc-500 hover:text-orange-500 font-medium transition flex items-center justify-center gap-1 mx-auto w-full py-2">
                            Show All ({{ future|length }}) <i class="ph ph-caret-down"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% if past %}
                <div><button onclick="togglePast()"
                        class="w-full flex items-center justify-between group mb-3 focus:outline-none">
                        <div class="flex items-center gap-2"><i
                                class="ph ph-clock-counter-clockwise text-zinc-500 group-hover:text-orange-500 transition"></i>
                            <h3
                                class="text-sm font-bold text-zinc-500 group-hover:text-zinc-700 dark:group-hover:text-zinc-300 uppercase tracking-wider transition">
                                Past</h3>
                        </div><i id="pastChevron"
                            class="ph ph-caret-down text-zinc-400 group-hover:text-orange-500 transition transform -rotate-90"></i>
                    </button>
                    <div id="pastList" class="hidden grid md:grid-cols-2 gap-4 opacity-75 hover:opacity-100 transition">
                        {% for id, t in past.items() %}{% include 'partials/tournament_card.html' %}{% endfor %}</div>
                </div>
                {% endif %}
                {% if not live and not future and not past %}
                <div
                    class="text-center py-20 bg-white dark:bg-zinc-800 rounded-xl border border-dashed border-gray-300 dark:border-zinc-700">
                    <p class="text-xl text-zinc-400">No tournaments found.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% include 'components/theme.html' %}
    {% include 'components/modals.html' %}

    <!-- DATA INJECTION FOR LINTER COMPLIANCE -->
    <script type="application/json" id="all-tournaments">{{ tournaments|tojson|safe }}</script>

    <script>
        const ALL_TOURNAMENTS = JSON.parse(document.getElementById('all-tournaments').textContent);
        let isAdmin = false;
        document.getElementById('themeIcon').className = document.documentElement.classList.contains('dark') ? 'ph ph-moon text-xl' : 'ph ph-sun text-xl';
        function togglePast() { const l = document.getElementById('pastList'), c = document.getElementById('pastChevron'); if (l.classList.contains('hidden')) { l.classList.remove('hidden'); c.classList.remove('-rotate-90'); c.classList.add('rotate-0') } else { l.classList.add('hidden'); c.classList.add('-rotate-90'); c.classList.remove('rotate-0') } }
        function toggleUpcoming() {
            const extras = document.querySelectorAll('.upcoming-extra');
            const btn = document.getElementById('showMoreUpcomingBtn');
            if (!btn || !extras.length) return;

            if (extras[0].classList.contains('hidden')) {
                // Expand
                extras.forEach(el => el.classList.remove('hidden'));
                btn.innerHTML = 'Show Less <i class="ph ph-caret-up"></i>';
            } else {
                // Collapse
                extras.forEach(el => el.classList.add('hidden'));
                btn.innerHTML = `Show All (${btn.dataset.count}) <i class="ph ph-caret-down"></i>`;
            }
        }

        async function checkAuth() {
            const res = await fetch('/api/check-auth'); const data = await res.json(); isAdmin = data.is_admin;
            const c = document.getElementById('authControls'); const btn = document.getElementById('createBtnContainer');
            if (isAdmin) {
                c.innerHTML = `<button onclick="logout()" class="h-10 w-10 flex items-center justify-center p-2 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800 transition text-zinc-600 dark:text-zinc-400"><i class="ph ph-sign-out text-xl"></i></button>`;
                btn.innerHTML = `
                    <button onclick="openTournamentModal('create')" class="flex items-center justify-center bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2">
                        <i class="ph ph-plus"></i> Create
                    </button>`;
                document.querySelectorAll('.admin-cog').forEach(el => el.classList.remove('hidden'));
            } else {
                c.innerHTML = `<button onclick="document.getElementById('loginModal').showModal()" class="h-10 w-10 flex items-center justify-center p-2 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800 transition text-zinc-600 dark:text-zinc-400"><i class="ph ph-lock-key text-xl"></i></button>`;
            }
        }

        // UNIFIED MODAL LOGIC
        function openTournamentModal(mode, id) {
            const modal = document.getElementById('tournamentModal');
            document.getElementById('tmError').classList.add('hidden');

            // Set fields based on mode
            if (mode === 'create') {
                document.getElementById('modalTitle').innerHTML = `<i class="ph ph-plus-circle text-orange-500"></i> New Tournament`;
                document.getElementById('submitBtn').innerText = 'Create';
                document.getElementById('deleteBtn').classList.add('hidden');
                document.getElementById('recalculateSection').classList.add('hidden');

                // Clear fields
                document.getElementById('tmId').value = '';
                document.getElementById('tmMode').value = 'create';
                document.getElementById('tmName').value = '';
                document.getElementById('tmCode').value = '';
                document.getElementById('tmDate').value = new Date().toLocaleDateString();
                document.getElementById('tmCourts').value = '';
                document.getElementById('tmTeams').value = '';
                document.getElementById('tmStartTime').value = '09:00';
                document.getElementById('tmDuration').value = '30';
            } else if (mode === 'edit') {
                const t = ALL_TOURNAMENTS[id];
                document.getElementById('modalTitle').innerHTML = `<i class="ph ph-sliders text-orange-500"></i> Settings`;
                document.getElementById('submitBtn').innerText = 'Save Changes';
                document.getElementById('deleteBtn').classList.remove('hidden');
                document.getElementById('recalculateSection').classList.remove('hidden');

                // Fill fields
                document.getElementById('tmId').value = id;
                document.getElementById('tmMode').value = 'edit';
                document.getElementById('tmName').value = t.name;
                document.getElementById('tmCode').value = t.code || '';
                document.getElementById('tmDate').value = t.date || '';
                document.getElementById('tmCourts').value = (t.courts || []).join(', ');
                document.getElementById('tmTeams').value = (t.teams || []).join('\n');
                document.getElementById('tmStartTime').value = t.start_time || '09:00';
                document.getElementById('tmDuration').value = t.match_duration || 30;
                document.getElementById('tmType').value = t.type || 'double';
            }
            modal.showModal();
        }

        async function submitTournament() {
            const mode = document.getElementById('tmMode').value;
            const id = document.getElementById('tmId').value;

            const payload = {
                name: document.getElementById('tmName').value,
                date: document.getElementById('tmDate').value,
                code: document.getElementById('tmCode').value,
                type: document.getElementById('tmType').value,
                courts: document.getElementById('tmCourts').value,
                duration: document.getElementById('tmDuration').value,
                start_time: document.getElementById('tmStartTime').value,
                teams: document.getElementById('tmTeams').value
            };

            let url = '/create';
            if (mode === 'edit') url = `/api/settings/${id}`;

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) location.reload();
            else {
                const err = await res.json();
                const errBox = document.getElementById('tmError');
                errBox.innerText = err.error || "Error saving tournament";
                errBox.classList.remove('hidden');
            }
        }

        // Helper for dashboard edit button
        function openDashboardSettings(id, event) {
            event.preventDefault(); event.stopPropagation();
            openTournamentModal('edit', id);
        }

        async function recalculateSchedule() {
            const id = document.getElementById('tmId').value;
            if ((await fetch(`/api/settings/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ recalculate: true }) })).ok) { location.reload(); }
        }

        async function deleteTournament() {
            const id = document.getElementById('tmId').value;
            if (confirm("Are you sure?")) { if ((await fetch(`/api/delete/${id}`, { method: 'POST' })).ok) location.reload(); }
        }

        async function performLogin() {
            const u = document.getElementById('loginUser').value; const p = document.getElementById('loginPass').value;
            if ((await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) })).ok) location.reload();
            else document.getElementById('loginError').classList.remove('hidden');
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.reload();
        }

        checkAuth();
    </script>
</body>

</html>