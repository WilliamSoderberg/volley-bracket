<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>VolleyManager</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.svg') }}">
    <!-- Link to the compiled CSS file we are about to generate -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dist/output.css') }}">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        // Check local storage or system preference on load
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            padding-top: env(safe-area-inset-top);
        }

        /* Prevent elastic scroll on body, allow internal scroll */
        .scroll-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>

<body
    class="bg-zinc-100 dark:bg-zinc-900 text-zinc-800 dark:text-zinc-100 h-[100dvh] flex flex-col overflow-hidden transition-colors duration-200">

    <!-- Scrollable Main Container -->
    <div class="scroll-container w-full">
        <div class="container mx-auto p-3 max-w-4xl">
            <!-- Header: Row layout for all screens -->
            <header class="flex flex-row justify-between mb-8 gap-4">
                <div class="flex items-center gap-3">
                    <i class="ph ph-volleyball text-3xl md:text-4xl text-orange-500"></i>
                    <div>
                        <h1 class="text-xl md:text-3xl font-bold text-zinc-900 dark:text-white leading-tight">
                            VolleyManager</h1>
                        <p class="text-xs md:text-base text-zinc-500 dark:text-zinc-400 hidden md:block">Tournament
                            Organizer</p>
                    </div>
                </div>
                <div id="authControls"></div>
            </header>

            <!-- Main Actions Row -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-zinc-700 dark:text-zinc-300">Active Tournaments</h2>
                <div id="createBtnContainer"></div>
            </div>

            <!-- Active Tournaments Grid -->
            <div class="grid md:grid-cols-2 gap-6 pb-20">
                {% for id, t in tournaments.items() %}
                <a href="/t/{{ id }}"
                    class="block bg-white dark:bg-zinc-800 p-6 rounded-xl shadow-sm hover:shadow-md dark:shadow-none hover:scale-[1.02] transition border border-gray-200 dark:border-zinc-700 group">
                    <div class="flex justify-between items-start mb-4">
                        <h2
                            class="text-xl font-bold truncate text-zinc-900 dark:text-white group-hover:text-orange-500 dark:group-hover:text-orange-400 transition">
                            {{ t.name }}</h2>
                        <span
                            class="bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 text-xs px-2 py-1 rounded font-mono border border-orange-200 dark:border-orange-800">{{
                            t.type|upper }}</span>
                    </div>
                    <div class="flex gap-4 text-sm text-zinc-500 dark:text-zinc-400">
                        <div class="flex items-center gap-1"><i class="ph ph-users text-orange-500"></i> {{
                            t.teams|length }} Teams</div>
                        <div class="flex items-center gap-1"><i class="ph ph-court-basketball text-orange-500"></i> {{
                            t.courts|length }} Courts</div>
                    </div>
                    <div
                        class="mt-4 flex items-center gap-2 text-xs text-zinc-400 border-t border-gray-100 dark:border-zinc-700 pt-3">
                        <i class="ph ph-hash"></i> ID: <span class="font-mono">{{ id }}</span>
                    </div>
                </a>
                {% else %}
                <div
                    class="col-span-2 text-center py-20 bg-white dark:bg-zinc-800 rounded-xl border border-dashed border-gray-300 dark:border-zinc-700">
                    <p class="text-xl text-zinc-400">No tournaments found.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <button onclick="toggleTheme()"
        class="flex items-center justify-center fixed z-50 right-4 bottom-6 bg-zinc-800 dark:bg-white text-white dark:text-zinc-900 p-3 rounded-full shadow-lg hover:scale-110 transition-transform duration-200 border border-zinc-700 dark:border-zinc-300 focus:outline-none focus:ring-2 focus:ring-orange-500"
        aria-label="Toggle Theme">
        <i id="themeIcon" class="ph ph-moon text-xl block"></i>
    </button>

    <!-- Create Modal -->
    <dialog id="createModal"
        class="bg-white dark:bg-zinc-900 text-zinc-900 dark:text-white rounded-xl shadow-2xl backdrop:bg-black/60 p-0 w-full max-w-lg m-auto border border-gray-200 dark:border-zinc-700">
        <form action="/create" method="POST" class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2"><i class="ph ph-plus-circle text-orange-500"></i>
                    New Tournament</h2>
                <button aria-label="Close score dialog" type="button"
                    onclick="document.getElementById('createModal').close()"
                    class="focus-visible:outline-none text-zinc-400 hover:text-zinc-900 dark:hover:text-white"><i
                        class="ph ph-x text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div><label class="block text-sm font-bold mb-1 text-zinc-500 uppercase text-xs">Name</label><input
                        type="text" name="name" placeholder="My Awesome Tournament" required enterkeyhint="next"
                        onkeydown="if(event.key==='Enter'){event.preventDefault(); document.getElementById('tournamentCode').focus();}"
                        class="w-full bg-gray-50 dark:bg-zinc-950 border border-gray-300 dark:border-zinc-600 rounded p-2 focus:border-orange-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-bold mb-1 text-zinc-500 uppercase text-xs">Code</label><input
                            type="text" name="code" placeholder="••••" required id="tournamentCode" enterkeyhint="next"
                            onkeydown="if(event.key==='Enter'){event.preventDefault(); document.getElementById('createType').focus();}"
                            class="w-full h-10 bg-gray-50 dark:bg-zinc-950 border border-gray-300 dark:border-zinc-600 rounded p-2 text-center font-mono">
                    </div>
                    <div><label class="block text-sm font-bold mb-1 text-zinc-500 uppercase text-xs">Type</label><select
                            name="type" id="createType" enterkeyhint="next"
                            onkeydown="if(event.key==='Enter'){event.preventDefault(); document.getElementById('teams').focus();}"
                            class="w-full h-10 bg-gray-50 dark:bg-zinc-950 border border-gray-300 dark:border-zinc-600 rounded p-2">
                            <option value="double">Double Elimination</option>
                            <option value="single">Single Elimination</option>
                        </select></div>
                </div>
                <div><label class="block text-sm font-bold mb-1 text-zinc-500 uppercase text-xs">Teams</label><textarea
                        name="teams" placeholder="One team per line..." required id="teams"
                        class="w-full h-34 bg-gray-50 dark:bg-zinc-950 border border-gray-300 dark:border-zinc-600 rounded p-2 font-mono text-sm focus:border-orange-500 outline-none"></textarea>
                </div>
                <div><label class="block text-sm font-bold mb-1 text-zinc-500 uppercase text-xs">Courts</label><input
                        type="text" name="courts" placeholder="Center Court, Court 1" required
                        onkeydown="if(event.key==='Enter'){event.preventDefault(); document.getElementById('createDuration').focus();}"
                        class="w-full bg-gray-50 dark:bg-zinc-950 border border-gray-300 dark:border-zinc-600 rounded p-2 focus:border-orange-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-bold mb-1 text-zinc-500 uppercase text-xs">Match
                            Duration</label><input type="number" pattern="[0-9]*" min="0" name="duration" value="30"
                            id="createDuration" enterkeyhint="next"
                            onkeydown="if(event.key==='Enter'){event.preventDefault(); document.getElementById('createStartTime').focus();}"
                            class="w-full bg-gray-50 dark:bg-zinc-950 border border-gray-300 dark:border-zinc-600 rounded p-2 h-10 text-base appearance-none">
                    </div>
                    <div><label class="block text-sm font-bold mb-1 text-zinc-500 uppercase text-xs">Start
                            Time</label><input type="time" name="start_time" value="10:00" id="createStartTime"
                            enterkeyhint="done"
                            class="w-full bg-gray-50 dark:bg-zinc-950 border border-gray-300 dark:border-zinc-600 rounded p-2 h-10 text-base appearance-none">
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3 border-t border-gray-200 dark:border-zinc-700 pt-4">
                <button type="submit" id="submitCreate"
                    class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded font-bold shadow-lg shadow-orange-900/20">Create
                    Tournament</button>
            </div>
        </form>
    </dialog>

    <dialog id="loginModal"
        class="bg-white dark:bg-zinc-800 text-zinc-900 dark:text-white rounded-xl shadow-2xl backdrop:bg-black/60 p-0 w-80 m-auto border border-gray-200 dark:border-zinc-700">
        <div class="p-6">
            <div class="flex justify-center">
                <div class="flex justify-between items-center bg-zinc-100 dark:bg-zinc-800 p-2 rounded-full"><i
                        class="ph ph-lock-key text-2xl text-orange-500"></i></div>
            </div>
            <h2 class="text-lg font-bold mb-4 text-center">Admin Login</h2>
            <div id="loginError" class="hidden text-xs text-red-500 text-center mb-3">Invalid Credentials</div>
            <input id="loginUser"
                class="w-full bg-gray-50 dark:bg-zinc-900 border border-gray-300 dark:border-zinc-600 rounded p-3 mb-3 focus:border-orange-500 outline-none transition"
                placeholder="Username" enterkeyhint="next"
                onkeydown="if(event.key==='Enter') document.getElementById('loginPass').focus()">
            <input type="password" id="loginPass"
                class="w-full bg-gray-50 dark:bg-zinc-900 border border-gray-300 dark:border-zinc-600 rounded p-3 mb-6 focus:border-orange-500 outline-none transition"
                placeholder="Password" enterkeyhint="done" onkeydown="if(event.key==='Enter') performLogin()">
            <div class="flex justify-between items-center">
                <form method="dialog"><button
                        class="px-3 py-1 text-zinc-400 text-sm hover:text-zinc-600 dark:hover:text-white">Cancel</button>
                </form>
                <button onclick="performLogin()"
                    class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-1 rounded font-bold">Login</button>
            </div>
        </div>
    </dialog>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
                document.getElementById('themeIcon').className = 'ph ph-sun text-xl';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
                document.getElementById('themeIcon').className = 'ph ph-moon text-xl';
            }
        }
        document.getElementById('themeIcon').className = document.documentElement.classList.contains('dark') ? 'ph ph-moon text-xl' : 'ph ph-sun text-xl';

        async function checkAuth() {
            const res = await fetch('/api/check-auth');
            const data = await res.json();
            const container = document.getElementById('authControls');
            const createBtn = document.getElementById('createBtnContainer');

            if (data.is_admin) {
                container.innerHTML = `<button onclick="logout()" class="h-10 w-10 flex items-center justify-center p-2 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800 transition text-zinc-600 dark:text-zinc-400"><i class="ph ph-sign-out text-xl"></i></button>`;
                createBtn.innerHTML = `
                    <button onclick="document.getElementById('createModal').showModal()" class="flex items-center justify-center bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2">
                        <i class="ph ph-plus"></i> Create
                    </button>`;
            } else {
                container.innerHTML = `<button onclick="document.getElementById('loginModal').showModal()" class="h-10 w-10 flex items-center justify-center p-2 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800 transition text-zinc-600 dark:text-zinc-400"><i class="ph ph-lock-key text-xl"></i></button>`;
            }
        }

        async function performLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, password: p })
            });
            if (res.ok) location.reload();
            else document.getElementById('loginError').classList.remove('hidden');
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.reload();
        }

        checkAuth();
    </script>
</body>

</html>