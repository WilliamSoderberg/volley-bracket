<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
    <title>{{ t.name }} - Bracket</title>

    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='dist/output.css') }}">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        // Check local storage or system preference on load
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .dark ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }

        .bracket-wrapper {
            display: flex;
            flex-direction: column;
            gap: 4rem;
            padding: 2rem;
            min-width: max-content;
        }

        .bracket-section {
            position: relative;
            padding: 1rem;
        }

        .wb-finals-row {
            display: flex;
            gap: 4rem;
            align-items: center;
        }

        .tree-container {
            display: flex;
            gap: 4rem;
        }

        .round-col {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            min-width: 280px;
            z-index: 10;
        }

        .match-card {
            width: 16rem;
        }

        .connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        path {
            fill: none;
            stroke: oklch(27.4% 0.006 286.033);
            stroke-width: 2;
            opacity: 0.5;
        }

        .dark path {
            stroke: oklch(70.5% 0.015 286.067);
        }

        .match-card {
            transition: all 0.2s;
        }

        .match-card:hover {
            transform: translateY(-2px);
        }

        .invisible-card {
            display: none;
        }

        body {
            padding-top: env(safe-area-inset-top);
        }

        body:has(dialog[open]) {
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding-top: env(safe-area-inset-top);
        }

        @media (max-width: 768px) {
            main {
                margin-bottom: env(safe-area-inset-bottom);
            }
        }

        /* --- PRINT STYLING --- */
        @media print {
            @page {
                size: auto;
                margin: 0.5cm;
            }

            nav,
            .fixed-action-btn,
            #themeIcon,
            #scheduleFilter,
            .ph-magnifying-glass,
            #authSection,
            button.bg-orange-600,
            span.planned,
            .hidden {
                display: none !important;
            }

            body,
            html,
            main {
                height: auto !important;
                width: 100% !important;
                overflow: visible !important;
                background-color: white !important;
                color: black !important;
                display: block !important;
                position: static !important;
            }

            #view-bracket:not(.hidden),
            #view-schedule:not(.hidden) {
                display: block !important;
                overflow: visible !important;
                height: auto !important;
            }

            #view-schedule .hidden.md\:block {
                display: block !important;
            }

            #mobileScheduleList {
                display: none !important;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th,
            td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }

            thead {
                background: #eee !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            tr {
                break-inside: avoid;
            }

            button {
                border: none !important;
                background: none !important;
                padding: 0 !important;
            }

            .bracket-wrapper {
                /* transform: scale(0.9); */
                transform-origin: top left;
                min-width: max-content !important;
                gap: 2rem !important;
            }

            .bracket-section {
                break-inside: avoid;
                page-break-inside: avoid;
                margin-bottom: 2rem;
            }

            path {
                stroke: rgb(56, 56, 56) !important;
                opacity: 1 !important;
                stroke-width: 3px !important;
            }

            .match-card {
                border: 1px solid #000 !important;
                box-shadow: none !important;
                background-color: white !important;
            }

            div.match-card div.tracking-wider,
            td div.tracking-wider {
                background: #333 !important;
            }

            div.wb-finals-row div.absolute.w-max {
                background: rgb(219, 219, 219) !important;
                color: rgb(0, 0, 0) !important;
            }

            div.match-card div.px-4.py-2,
            div.match-card span.px-2.rounded.text-xs.text-zinc-500 {
                background: rgb(219, 219, 219) !important;
            }

            div.match-card span.text-xs.italic,
            td span.italic {
                color: rgb(218, 218, 218) !important;
            }

            #view-bracket {
                background: none !important;
            }

            .text-zinc-400,
            .text-zinc-500,
            .text-zinc-600,
            .text-zinc-700,
            .text-zinc-800,
            .text-zinc-900 .dark .text-zinc-400 {
                color: #333 !important;
            }
        }
    </style>
</head>

<body
    class="bg-zinc-50 dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 font-sans h-[100dvh] flex flex-col overflow-hidden transition-colors duration-200">
    <nav
        class="pt-[calc(0.75rem+env(safe-area-inset-top))] bg-zinc-50 dark:bg-zinc-900 border-b border-gray-200 dark:border-zinc-800 pb-3 shadow-sm dark:shadow-md z-50 shrink-0 transition-colors duration-200">
        <div class="flex justify-between h-10 max-w-4xl mx-auto w-full pr-3 pl-3">
            <a href="/"
                class="h-10 w-10 flex items-center justify-center p-2 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800 transition text-zinc-600 dark:text-zinc-400">
                <i class="ph ph-house text-xl"></i></a>

            <div class="self-center text-center absolute left-1/2 -translate-x-1/2">
                <div class="text-xs text-zinc-400 dark:text-zinc-500 mt-1 font-mono">{{ t.date }}</div>
                <h1 class="text-base font-bold text-zinc-800 dark:text-white truncate max-w-[150px] md:max-w-xs"
                    id="navTitle">{{ t.name }}</h1>
            </div>
            <div id="authSection" class="flex gap-1"></div>
        </div>
    </nav>

    <main class="flex-1 overflow-hidden relative bg-zinc-50 dark:bg-zinc-950 transition-colors duration-200">
        <div id="view-bracket"
            class="w-full h-full overflow-auto bg-[radial-gradient(#b2b2b2_1px,transparent_1px)] dark:bg-[radial-gradient(#202020_1px,transparent_1px)] [background-size:20px_20px] pt-8">
            <div class="bracket-wrapper" id="bracketRoot">
                <!-- Content injected via JS -->
            </div>
        </div>
        <div id="view-schedule" class="hidden w-full h-full overflow-auto p-4 md:p-8">
            <div class="max-w-3xl mx-auto space-y-4 pb-20">
                <div class="relative group">
                    <input type="text" enterkeyhint="search"
                        onkeyup="if(event.key==='Enter') this.blur(); else filterSchedule()" id="scheduleFilter"
                        placeholder="Search teams..."
                        class="w-full bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl p-3 pl-10 text-zinc-900 dark:text-white focus:ring-1 focus:ring-orange-500 outline-none transition placeholder-zinc-400 dark:placeholder-zinc-600">
                    <i
                        class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400 dark:text-zinc-500 text-lg group-hover:text-orange-500 transition"></i>
                </div>
                <div
                    class="bg-transparent md:bg-white md:dark:bg-zinc-900 md:rounded-xl md:shadow-sm md:overflow-hidden md:border md:border-gray-200 md:dark:border-zinc-800 transition-colors">
                    <div class="hidden md:block">
                        <table class="w-full text-left">
                            <thead
                                class="bg-zinc-50 dark:bg-zinc-950/50 text-zinc-500 text-xs uppercase font-bold tracking-wider border-b border-gray-200 dark:border-zinc-800">
                                <tr>
                                    <th class="p-4">Time / Court</th>
                                    <th class="p-4">Match</th>
                                    <th class="p-4 text-right">Result</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 dark:divide-zinc-800" id="tableBody"></tbody>
                        </table>
                    </div>
                    <div id="mobileScheduleList" class="md:hidden space-y-3"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Action Buttons -->
    <div class="fixed z-50 right-4 bottom-6 flex flex-col gap-3 fixed-action-btn">
        <!-- Universal View Switcher -->
        <button onclick="toggleView()" id="viewToggleBtn"
            class="flex items-center justify-center bg-orange-600 hover:bg-orange-500 text-white p-3 rounded-full shadow-lg hover:scale-110 transition-transform duration-200 border border-orange-700 focus:outline-none hover:ring-2 hover:ring-orange-500">
            <i id="viewIcon" class="ph ph-calendar-dots text-xl block"></i>
        </button>

        <!-- Theme Switcher -->
        <button onclick="toggleTheme()"
            class="flex items-center justify-center bg-zinc-800 dark:bg-white text-white dark:text-zinc-900 p-3 rounded-full shadow-lg hover:scale-110 transition-transform duration-200 border border-zinc-700 dark:border-zinc-300 focus:outline-none hover:ring-2 hover:ring-orange-500">
            <i id="themeIcon" class="ph ph-moon text-xl block"></i>
        </button>
    </div>

    <!-- Shared Modals -->
    {% include 'components/modals.html' %}


    <!-- Score Modal (unchanged) -->
    <dialog id="scoreModal"
        class="bg-white dark:bg-zinc-900 text-zinc-900 dark:text-white rounded-xl shadow-2xl backdrop:bg-black/20 dark:backdrop:bg-black/90 p-0 w-full max-w-md border border-gray-200 dark:border-zinc-700 m-auto transition-colors">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl flex items-center gap-2"><i class="ph ph-trophy text-orange-500"></i> Match
                    #<span id="modalMatchIdDisp"></span></h3>
                <button type="button" onclick="document.getElementById('scoreModal').close()"
                    class="focus-visible:outline-none text-zinc-400 hover:text-zinc-900 dark:hover:text-white"><i
                        class="ph ph-x text-xl" tabindex="-1"></i></button>
            </div>
            <div
                class="flex justify-center items-center gap-4 mb-6 bg-zinc-50 dark:bg-zinc-950 p-3 rounded-lg border border-gray-200 dark:border-zinc-800">
                <div class="flex items-center gap-2 text-sm font-mono text-zinc-600 dark:text-zinc-300"><i
                        class="ph ph-clock text-orange-500"></i> <span id="modalTimeDisplay">--:--</span></div>
                <div class="h-4 w-px bg-zinc-300 dark:bg-zinc-800"></div>
                <div class="flex items-center gap-2 text-sm font-mono text-zinc-900 dark:text-white"><i
                        class="ph ph-court-basketball text-orange-500"></i> <span id="modalCourtDisplay">TBD</span>
                </div>
            </div>
            <div id="scoreError"
                class="hidden text-xs text-red-500 dark:text-red-400 text-center mb-4 bg-red-50 dark:bg-red-900/10 p-2 rounded border border-red-200 dark:border-red-900/30">
            </div>
            <div id="refAuthSection"
                class="mb-6 bg-zinc-50 dark:bg-zinc-950 p-4 rounded-lg border border-gray-200 dark:border-zinc-800">
                <label class="block text-xs font-bold text-orange-500 uppercase mb-2">Tournament Code</label>
                <input type="password" id="scoreCode"
                    class="w-full bg-white dark:bg-zinc-900 border border-gray-300 dark:border-zinc-700 rounded p-3 text-center text-lg tracking-[0.5em] focus:ring-1 focus:ring-orange-500 outline-none transition text-zinc-900 dark:text-white"
                    placeholder="•••••" autocomplete="off">
            </div>
            <div
                class="grid grid-cols-3 gap-2 text-center font-bold text-zinc-700 dark:text-zinc-200 mb-4 items-center">
                <div id="mP1" class="break-words text-sm leading-tight"></div>
                <div
                    class="text-zinc-400 dark:text-zinc-600 text-[10px] font-bold uppercase bg-zinc-100 dark:bg-zinc-950 px-2 py-1 rounded-full w-fit mx-auto">
                    VS</div>
                <div id="mP2" class="break-words text-sm leading-tight"></div>
            </div>
            <div id="setsContainer" class="space-y-2 mb-6 max-h-48 overflow-y-auto pr-1"></div>
            <button onclick="addSet()"
                class="w-full py-2 border border-dashed border-zinc-300 dark:border-zinc-700 text-zinc-500 dark:text-zinc-400 text-sm mb-4 hover:border-orange-500 hover:text-orange-500 transition rounded">+
                Add Set</button>
            <div class="flex gap-2">
                <button id="clearBtn" onclick="clearScore()"
                    class="hidden w-1/3 bg-red-100 dark:bg-red-900/50 hover:bg-red-200 dark:hover:bg-red-900 text-red-600 dark:text-red-300 py-3 rounded-lg font-bold transition text-sm">Clear</button>
                <button id="submitBtn" onclick="submitScore()"
                    class="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded-lg font-bold shadow-lg shadow-orange-900/20 transition text-white">Submit
                    Result</button>
            </div>
        </div>
    </dialog>

    <!-- DATA INJECTION -->
    <script type="application/json" id="tournament-data">{{ t|tojson|safe }}</script>
    <script type="application/json" id="schedule-data">{{ schedule|tojson|safe }}</script>

    <script>
        const TOURNAMENT = JSON.parse(document.getElementById('tournament-data').textContent);
        let SCHEDULE_DATA = JSON.parse(document.getElementById('schedule-data').textContent);

        let activeMatchId = null; let isAdmin = false; const T_ID = TOURNAMENT.id;
        const COURT_COLORS = ['#ea580c', '#0284c7', '#059669', '#ca8a04', '#dc2626', '#0891b2', '#e11d48', '#65a30d'];
        function stringToColor(str) { let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); return COURT_COLORS[Math.abs(hash) % COURT_COLORS.length]; }
        let lastDataString = "";
        let currentView = 'bracket'; // Default view

        document.getElementById('themeIcon').className = document.documentElement.classList.contains('dark') ? 'ph ph-moon text-xl' : 'ph ph-sun text-xl';

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
                document.getElementById('themeIcon').className = 'ph ph-sun text-xl';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
                document.getElementById('themeIcon').className = 'ph ph-moon text-xl';
            }
        }

        async function fetchTournamentData() {
            try {
                if (document.getElementById('scoreModal').open || document.getElementById('tournamentModal').open || document.getElementById('loginModal').open) return;
                const res = await fetch(`/api/t/${T_ID}`); const data = await res.json();
                const currentDataString = JSON.stringify(data);
                if (currentDataString === lastDataString) return;
                lastDataString = currentDataString;
                TOURNAMENT.matches = data.tournament.matches; TOURNAMENT.name = data.tournament.name; TOURNAMENT.courts = data.tournament.courts; TOURNAMENT.teams = data.tournament.teams; TOURNAMENT.start_time = data.tournament.start_time; TOURNAMENT.match_duration = data.tournament.match_duration; TOURNAMENT.date = data.tournament.date; TOURNAMENT.type = data.tournament.type; TOURNAMENT.code = data.tournament.code; SCHEDULE_DATA = data.schedule;
                document.getElementById('navTitle').innerText = TOURNAMENT.name;
                const sx = document.getElementById('view-bracket').scrollLeft, sy = document.getElementById('view-bracket').scrollTop;
                renderBracket(); renderScheduleTable();
                document.getElementById('view-bracket').scrollLeft = sx; document.getElementById('view-bracket').scrollTop = sy;
                if (!document.getElementById('view-bracket').classList.contains('hidden')) setTimeout(drawConnections, 50);
            } catch (e) { console.error("Poll failed", e); }
        }
        setInterval(fetchTournamentData, 5000);

        async function checkAuth() { isAdmin = (await (await fetch('/api/check-auth')).json()).is_admin; renderAuthUI(); }
        function renderAuthUI() {
            const c = document.getElementById('authSection');
            if (isAdmin) { c.innerHTML = `<button onclick="openSettings()" class="h-10 w-10 flex items-center justify-center p-2 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800 transition text-zinc-600 dark:text-zinc-400"><i class="ph ph-gear text-xl"></i></button><button onclick="logout()" class="h-10 w-10 flex items-center justify-center p-2 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800 transition text-zinc-600 dark:text-zinc-400"><i class="ph ph-sign-out text-xl"></i></button>`; document.getElementById('refAuthSection').classList.add('hidden'); }
            else { c.innerHTML = `<button onclick="document.getElementById('loginModal').showModal()" class="h-10 w-10 flex items-center justify-center p-2 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800 transition text-zinc-600 dark:text-zinc-400"><i class="ph ph-lock-key text-xl"></i></button>`; document.getElementById('refAuthSection').classList.remove('hidden'); }
        }
        async function performLogin() { if ((await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: document.getElementById('loginUser').value, password: document.getElementById('loginPass').value }) })).ok) location.reload(); else document.getElementById('loginError').classList.remove('hidden'); }
        async function logout() { await fetch('/api/logout', { method: 'POST' }); location.reload(); }

        function openSettings() { openTournamentModal('edit', TOURNAMENT); }
        function openTournamentModal(mode, data) {
            const modal = document.getElementById('tournamentModal');
            document.getElementById('tmError').classList.add('hidden');
            document.getElementById('modalTitle').innerHTML = `<i class="ph ph-sliders text-orange-500"></i> Settings`;
            document.getElementById('submitBtn').innerText = 'Save Changes';
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('recalculateSection').classList.remove('hidden');
            document.getElementById('tmId').value = data.id || T_ID;
            document.getElementById('tmMode').value = 'edit';
            document.getElementById('tmName').value = data.name;
            document.getElementById('tmCode').value = data.code || '';
            document.getElementById('tmDate').value = data.date || '';
            document.getElementById('tmCourts').value = (data.courts || []).join(', ');
            document.getElementById('tmTeams').value = (data.teams || []).join('\n');
            document.getElementById('tmStartTime').value = data.start_time || '09:00';
            document.getElementById('tmDuration').value = data.match_duration || 30;
            document.getElementById('tmType').value = data.type || 'double';
            modal.showModal();
        }

        async function submitTournament() {
            const id = document.getElementById('tmId').value;
            const payload = {
                name: document.getElementById('tmName').value,
                date: document.getElementById('tmDate').value,
                code: document.getElementById('tmCode').value,
                type: document.getElementById('tmType').value,
                courts: document.getElementById('tmCourts').value,
                duration: document.getElementById('tmDuration').value,
                start_time: document.getElementById('tmStartTime').value,
                teams: document.getElementById('tmTeams').value
            };
            const res = await fetch(`/api/settings/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (res.ok) location.reload(); else { const err = await res.json(); document.getElementById('tmError').innerText = err.error; document.getElementById('tmError').classList.remove('hidden'); }
        }

        async function recalculateSchedule() { const id = document.getElementById('tmId').value; if ((await fetch(`/api/settings/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ recalculate: true }) })).ok) { location.reload(); } }
        async function deleteTournament() { const id = document.getElementById('tmId').value; if (confirm("Are you sure?")) { if ((await fetch(`/api/delete/${id}`, { method: 'POST' })).ok) window.location.href = '/'; } }

        function renderScheduleTable() {
            const tb = document.getElementById('tableBody'), ml = document.getElementById('mobileScheduleList'); let hT = '', hM = '';
            SCHEDULE_DATA.forEach(m => {
                const color = stringToColor(m.court + 'salt');
                const p1 = m.p1 || `<span class="text-sm italic text-zinc-400 dark:text-zinc-500">${m.p1_label}</span>`, p2 = m.p2 || `<span class="text-sm italic text-zinc-400 dark:text-zinc-500">${m.p2_label}</span>`;
                hT += `<tr class="schedule-row hover:bg-gray-50 dark:hover:bg-zinc-900 transition border-b border-gray-100 dark:border-zinc-800"><td class="p-4"><div class="text-lg font-bold text-zinc-800 dark:text-white font-mono">${m.time}</div><div class="text-[10px] font-bold px-2 py-0.5 rounded w-fit mt-1 text-white uppercase tracking-wider" style="background:${color}">${m.court}</div></td><td class="p-4"><div class="font-medium text-zinc-800 dark:text-zinc-200 team-names text-base">${p1} <span class="text-zinc-400 dark:text-zinc-600 text-sm mx-1">vs</span> ${p2}</div><div class="text-xs text-zinc-400 dark:text-zinc-500 mt-1 uppercase tracking-wide">Match #${m.number} • ${m.bracket} R${m.round}</div></td><td class="p-4 text-right">${getButtonHtml(m)}</td></tr>`;
                hM += `<div class="schedule-row bg-white dark:bg-zinc-900 p-4 rounded-xl border border-gray-200 dark:border-zinc-800 shadow-sm"><div class="flex justify-between items-start mb-3"><div><div class="text-xl font-bold text-zinc-800 dark:text-white font-mono">${m.time}</div><div class="text-[10px] font-bold px-2 py-0.5 rounded w-fit mt-1 text-white uppercase tracking-wider" style="background:${color}">${m.court}</div></div><div>${getButtonHtml(m)}</div></div><div class="font-medium text-base text-zinc-800 dark:text-zinc-200 team-names mb-1">${p1} <span class="text-zinc-400 dark:text-zinc-600 text-xs font-bold uppercase">vs</span> ${p2}</div><div class="text-[10px] text-zinc-400 dark:text-zinc-500 uppercase tracking-wider font-bold mt-2">Match #${m.number} • ${m.bracket} R${m.round}</div></div>`;
            });
            tb.innerHTML = hT; ml.innerHTML = hM;
        }
        function getButtonHtml(m) {
            if (m.winner) return `<button onclick="openScore('${m.id}')" class="text-right hover:bg-gray-100 dark:hover:bg-zinc-800 p-2 rounded transition group"><div class="text-orange-500 font-bold text-sm flex items-center justify-end gap-1"><i class="ph ph-trophy"></i> ${m.winner}</div><div class="text-xs text-zinc-500 dark:text-zinc-400 font-mono font-bold mt-0.5 text-right">${m.p1_sets} - ${m.p2_sets}</div></button>`;
            if (m.p1 && m.p2) return `<button onclick="openScore('${m.id}')" class="bg-orange-600 hover:bg-orange-500 text-white text-xs px-4 py-1.5 rounded-full font-bold transition shadow-lg shadow-orange-900/20">Report Results</button>`;
            return `<span class="planned text-[10px] text-zinc-400 dark:text-zinc-500 border border-gray-200 dark:border-zinc-800 px-2 py-1 rounded font-mono">PLANNED</span>`;
        }
        function filterSchedule() { const term = document.getElementById('scheduleFilter').value.toLowerCase(); document.querySelectorAll('.schedule-row').forEach(row => { row.style.display = row.querySelector('.team-names').innerText.toLowerCase().includes(term) ? '' : 'none'; }); }

        function renderBracket() {
            const root = document.getElementById('bracketRoot'); root.innerHTML = '';
            const wb = TOURNAMENT.matches.filter(m => m.bracket !== 'losers'), lb = TOURNAMENT.matches.filter(m => m.bracket === 'losers'), fin = TOURNAMENT.matches.filter(m => m.bracket === 'finals');

            // 1. Winners + Finals (Visual Continuity)
            const wbSection = document.createElement('div');
            wbSection.className = 'bracket-section';
            wbSection.id = 'wbSection';
            const wbSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            wbSvg.setAttribute("class", "connections-layer");
            wbSvg.id = "wbConnections";
            wbSection.appendChild(wbSvg);

            const topRow = document.createElement('div'); topRow.className = 'wb-finals-row';
            const wbC = document.createElement('div'); wbC.className = 'tree-container relative'; wbC.innerHTML = `<div class="absolute -top-10 left-0 text-zinc-700 dark:text-zinc-500 font-bold uppercase tracking-widest text-xs">Winners Bracket</div>`;

            // Separate Winners from Finals for the tree generation
            const onlyWinners = wb.filter(m => m.bracket !== 'finals');
            renderTree(onlyWinners, wbC);
            topRow.appendChild(wbC);

            // Append Finals if any
            if (fin.length) {
                const fCol = document.createElement('div');
                fCol.className = 'flex flex-col justify-center items-center gap-2 min-w-[280px] z-10 relative'; // Added relative
                // Use absolute positioning for the title so it doesn't affect flow
                fCol.innerHTML = `<div class="absolute -top-10 left-1/2 -translate-x-1/2 rounded-lg bg-orange-200 dark:bg-orange-800 pt-1 pb-1 pl-2 pr-2 text-center text-orange-600 dark:text-orange-200 font-bold uppercase tracking-widest text-xs mb-1 w-max shadow-sm"><i class="ph ph-trophy"></i> FINALS</div>`;
                fin.forEach(m => fCol.appendChild(createCard(m)));
                topRow.appendChild(fCol);
            }
            wbSection.appendChild(topRow);
            root.appendChild(wbSection);

            // 2. Losers Bracket
            if (lb.length) {
                const lbSection = document.createElement('div');
                lbSection.className = 'bracket-section';
                lbSection.id = 'lbSection';
                const lbSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                lbSvg.setAttribute("class", "connections-layer");
                lbSvg.id = "lbConnections";
                lbSection.appendChild(lbSvg);

                const lbC = document.createElement('div');
                lbC.className = 'tree-container relative pt-12 border-t border-gray-200 dark:border-zinc-800';
                lbC.innerHTML = `<div class="absolute top-4 left-0 text-zinc-700 dark:text-zinc-500 font-bold uppercase tracking-widest text-xs">Losers Bracket</div>`;
                renderTree(lb, lbC);
                lbSection.appendChild(lbC);
                root.appendChild(lbSection);
            }
        }
        function renderTree(matches, container) {
            const rounds = {}; matches.forEach(m => { if (!rounds[m.round]) rounds[m.round] = []; rounds[m.round].push(m) });
            Object.keys(rounds).sort((a, b) => a - b).forEach(r => { const hasVis = rounds[r].some(m => m.number); if (hasVis) { const col = document.createElement('div'); col.className = 'round-col'; rounds[r].sort((a, b) => parseInt(a.id) - parseInt(b.id)).forEach(m => col.appendChild(createCard(m))); container.appendChild(col); } });
        }
        function createCard(m) {
            const div = document.createElement('div'); div.id = `match-${m.id}`; if (!m.number) div.classList.add('invisible-card');
            const color = m.time ? stringToColor(m.court + 'salt') : 'transparent';
            div.className = `match-card w-64 bg-white dark:bg-zinc-900 rounded-xl border border-gray-400 cursor-pointer select-none relative overflow-hidden group ${!m.number ? 'invisible-card' : ''} ${m.winner ? 'border-orange-400 dark:border-orange-600 ring-1 ring-orange-400 dark:ring-orange-600' : 'dark:border-zinc-700'}`;
            div.onclick = () => { if (m.p1 && m.p2) openScore(m.id); };
            const status = m.winner ? '<span class="text-orange-500 font-bold text-xs"><i class="ph ph-check"></i> Played</span>' : (m.status === 'Scheduled' ? `<span class="text-zinc-800 dark:text-white font-bold text-xs font-mono">${m.time}</span>` : '<span class="text-zinc-400 dark:text-zinc-600 text-xs">Pending</span>');
            const courtName = m.time ? m.court : '';
            const courtBadge = m.time ? `<div class="text-[10px] font-bold px-2 py-0.5 rounded w-fit text-white uppercase tracking-wider mr-2" style="background:${color}">${courtName}</div>` : '';
            const p1 = m.p1 || `<span class="text-xs italic text-zinc-400 dark:text-zinc-600">${m.p1_label}</span>`, p2 = m.p2 || `<span class="text-xs italic text-zinc-400 dark:text-zinc-600">${m.p2_label}</span>`;
            div.innerHTML = `<div class="px-4 py-2 bg-gray-50 dark:bg-zinc-950/30 flex justify-between items-center border-b border-gray-200 dark:border-zinc-800"><div class="flex items-center gap-1"><span class="font-mono text-zinc-400 dark:text-zinc-500 text-xs mr-2">#${m.number || '-'}</span>${courtBadge}</div>${status}</div><div class="p-3 space-y-2"><div class="flex justify-between items-center ${m.winner === m.p1 ? 'text-orange-600 dark:text-orange-500 font-bold' : 'text-zinc-500 dark:text-zinc-400'}"><span class="text-zinc-600 dark:text-zinc-300 truncate pr-2 text-sm">${p1}</span><span class="bg-gray-100 dark:bg-zinc-950 px-2 py-0.5 rounded text-xs text-zinc-500">${m.p1_sets}</span></div><div class="flex justify-between items-center ${m.winner === m.p2 ? 'text-orange-600 dark:text-orange-500 font-bold' : 'text-zinc-500 dark:text-zinc-400'}"><span class="text-zinc-600 dark:text-zinc-300 truncate pr-2 text-sm">${p2}</span><span class="bg-gray-100 dark:bg-zinc-950 px-2 py-0.5 rounded text-xs text-zinc-500">${m.p2_sets}</span></div></div>`;
            return div;
        }
        function openScore(id) {
            document.getElementById('scoreError').classList.add('hidden');
            const m = TOURNAMENT.matches.find(x => x.id === id);
            if (!m.p1 || !m.p2) return;
            activeMatchId = id; document.getElementById('modalMatchIdDisp').innerText = m.number || id; document.getElementById('mP1').innerText = m.p1 || m.p1_label; document.getElementById('mP2').innerText = m.p2 || m.p2_label;
            document.getElementById('modalTimeDisplay').innerText = m.time || "--:--";
            document.getElementById('modalCourtDisplay').innerText = m.court || "TBD";
            document.getElementById('scoreCode').value = '';
            const clearBtn = document.getElementById('clearBtn');
            if (m.winner) { clearBtn.classList.remove('hidden'); clearBtn.classList.add('block'); } else { clearBtn.classList.add('hidden'); clearBtn.classList.remove('block'); }
            document.getElementById('scoreModal').showModal();
            const c = document.getElementById('setsContainer'); c.innerHTML = ''; if (m.sets && m.sets.length) m.sets.forEach(s => addSet(s.p1, s.p2)); else addSet();
        }
        function addSet(v1 = '', v2 = '') { const d = document.createElement('div'); d.className = "grid grid-cols-3 gap-2 items-center"; d.innerHTML = `<input pattern="[0-9]*" type="number" min="0" class="sp1 w-full bg-gray-50 dark:bg-zinc-950 border border-gray-300 dark:border-zinc-800 p-2 rounded text-center focus:border-orange-500 outline-none text-zinc-900 dark:text-white" value="${v1}"><span class="text-zinc-400 dark:text-zinc-600 text-center font-bold">-</span><input type="number" min="0" pattern="[0-9]*" class="sp2 w-full bg-gray-50 dark:bg-zinc-950 border border-gray-300 dark:border-zinc-800 p-2 rounded text-center focus:border-orange-500 outline-none text-zinc-900 dark:text-white" value="${v2}">`; document.getElementById('setsContainer').appendChild(d); }
        async function submitScore() {
            try {
                const btn = document.getElementById('submitBtn'); btn.innerHTML = `<i class="ph ph-spinner animate-spin"></i> Submitting...`;
                const code = document.getElementById('scoreCode').value, sets = [];
                document.querySelectorAll('#setsContainer > div').forEach(d => { const s1 = d.querySelector('.sp1').value, s2 = d.querySelector('.sp2').value; if (s1 !== '' && s2 !== '') sets.push({ p1: s1, p2: s2 }) });
                const res = await fetch(`/api/report/${TOURNAMENT.id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: activeMatchId, sets, code }) });
                if (res.ok) { document.getElementById('scoreModal').close(); fetchTournamentData(); } else showError('scoreError', (await res.json()).error);
            } catch (e) { showError('scoreError', "Network error"); } finally { document.getElementById('submitBtn').innerHTML = 'Submit Result'; }
        }
        async function clearScore() { if (!confirm("Clear results for this match?")) return; const code = document.getElementById('scoreCode').value; const res = await fetch(`/api/report/${TOURNAMENT.id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: activeMatchId, clear: true, code }) }); if (res.ok) { document.getElementById('scoreModal').close(); fetchTournamentData(); } else showError('scoreError', (await res.json()).error); }
        function showError(elementId, msg) { const el = document.getElementById(elementId); el.innerText = msg || "An error occurred"; el.classList.remove('hidden'); }

        // --- VIEW SWITCHER LOGIC ---
        function toggleView() {
            if (currentView === 'bracket') {
                // Switch to Schedule
                currentView = 'schedule';
                document.getElementById('view-bracket').classList.add('hidden');
                document.getElementById('view-schedule').classList.remove('hidden');
                document.getElementById('viewIcon').className = 'ph ph-tree-structure text-xl block'; // Show tree icon to go back
            } else {
                // Switch to Bracket
                currentView = 'bracket';
                document.getElementById('view-schedule').classList.add('hidden');
                document.getElementById('view-bracket').classList.remove('hidden');
                document.getElementById('viewIcon').className = 'ph ph-calendar-dots text-xl block'; // Show list icon to go to schedule
                setTimeout(drawConnections, 50);
            }
        }

        function drawConnections() {
            const wbSvg = document.getElementById('wbConnections'); const wbSection = document.getElementById('wbSection');
            if (wbSvg && wbSection) { wbSvg.innerHTML = ''; wbSvg.style.width = wbSection.scrollWidth + 'px'; wbSvg.style.height = wbSection.scrollHeight + 'px'; TOURNAMENT.matches.filter(m => m.bracket !== 'losers').forEach(m => drawMatchConnection(m, wbSvg, wbSection)); }
            const lbSvg = document.getElementById('lbConnections'); const lbSection = document.getElementById('lbSection');
            if (lbSvg && lbSection) { lbSvg.innerHTML = ''; lbSvg.style.width = lbSection.scrollWidth + 'px'; lbSvg.style.height = lbSection.scrollHeight + 'px'; TOURNAMENT.matches.filter(m => m.bracket === 'losers').forEach(m => drawMatchConnection(m, lbSvg, lbSection)); }
        }
        function drawMatchConnection(m, svg, container) {
            const s = document.getElementById(`match-${m.id}`); const n = document.getElementById(`match-${m.next_win}`);
            if (s && !s.classList.contains('invisible-card') && n) { if (!container.contains(n)) return; drawPath(svg, s, n, container); }
        }
        function drawPath(svg, el1, el2, container) {
            const r1 = el1.getBoundingClientRect(); const r2 = el2.getBoundingClientRect(); const root = container.getBoundingClientRect();
            const sx = r1.right - root.left; const sy = r1.top + r1.height / 2 - root.top; const ex = r2.left - root.left; const ey = r2.top + r2.height / 2 - root.top;
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); const c1 = sx + (ex - sx) / 2;
            path.setAttribute("d", `M ${sx} ${sy} C ${c1} ${sy}, ${c1} ${ey}, ${ex} ${ey}`); svg.appendChild(path);
        }

        checkAuth(); fetchTournamentData();
        // Init logic for view
        if (currentView === 'bracket') setTimeout(drawConnections, 50);
    </script>
</body>

</html>